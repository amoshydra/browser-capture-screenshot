---
import Time from "../components/Time.astro"
---

<div>
  <div class="columns demo-container">
    <div
      class="demo column"
      id="demo_demo"
      contenteditable="true"
      spellcheck="false"
      style="display: flex; flex-direction: column; gap: 1rem;"
      >
      <div style="padding: 0.5rem; border: 2px dashed blue;">
        <input type="date" />
      </div>
      <div style="padding: 0.5rem; border: 2px dashed green;">Demo</div>
      <div style="padding: 0.5rem; border: 2px dashed red;">📸👽🍛🪑🦸‍♀️🐀💾</div>
      <div style="padding: 0.5rem; border: 2px dashed blue;"><Time /></div>
    </div>
    <img
      class="preview column"
      id="demo_preview"
      src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
    />
  </div>
  <pre
    id="demo_input"
    spellcheck="false"
    contenteditable="true"
    class="input astro-code github-dark"
    style="background-color:#24292e;color:#e1e4e8;overflow-x:auto"
    tabindex="0"
    data-language="ts">
<code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> &#123; captureScreenshot &#125; </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "browser-capture-screenshot"</span><span style="color:#E1E4E8">;</span></span>
<span class="line" />
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> screenshot</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> captureScreenshot</span><span style="color:#E1E4E8">(demoElement);</span></span>
<span class="line"><span style="color:#E1E4E8">previewElement.src </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> screenshot;</span></span>
</code></pre>
  <div style="text-align: right">
    <button id="demo_button">Capture screenshot</button>
  </div>
</div>

<script>
  import * as BrowserCaptureScreenshot from "browser-capture-screenshot";

  const elements = {
    preview: document.getElementById("demo_preview") as HTMLImageElement,
    input: document.getElementById("demo_input") as HTMLTextAreaElement,
    button: document.getElementById("demo_button") as HTMLButtonElement,
  };

  elements.button.addEventListener("click", async () => {
    const inputContent = elements.input.textContent || "";
    const code = inputContent
      .split("\n")
      // remove import line
      .reduce(
        (acc, line) => {
          if (acc.done) {
            acc.content.push(line);
            return acc;
          }
          if (line.includes(`from "browser-capture-screenshot"`)) {
            acc.done = true;
            return acc;
          }
          return acc;
        },
        { content: [] as string[], done: false },
      )
      .content.join("\n")
    ;

    Object.defineProperty(window, "__context", {
      writable: true,
      value: {
        BrowserCaptureScreenshot,
      },
    });

    // Execute user's code
    eval(/*javascript*/`
      (async({
        BrowserCaptureScreenshot: {
          captureScreenshot,
          setup,
          focus,
          rasterize,
        },
      }) => {
        const demoElement = document.getElementById("demo_demo");
        const previewElement = document.getElementById("demo_preview");
        ${code}
      })(window.__context);
    `);
  });
</script>

<style>
  .demo-container {
    border: 1px solid blue;
    box-sizing: border-box;
  }
  .demo {
    padding: 1rem;
    border: 1px dashed red;
  }
  .columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    width: 100%;
    gap: 4px;
    min-width: 0;
    margin-bottom: 1rem;
  }
  .preview {
    all: unset;
    width: 100%;
  }
  .input {
    background-color: #24292e;
    color: #e1e4e8;
    overflow-x: auto;
    font-family: monospace;
    padding: 1rem;
    line-height: 1.5;
    white-space: pre;
    font-weight: 600;
  }

  button {
    padding: 1rem;
    font-size: 1rem;
    font-weight: 600;
  }
</style>
